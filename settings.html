<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>X Tech Intel | Settings</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: {
        colors: { primary: '#1978e5', accent: '#ec5b13', 'background-light': '#f6f7f8', 'background-dark': '#111821' },
        fontFamily: { display: ['Inter', 'sans-serif'] },
        borderRadius: { DEFAULT: '0.25rem', lg: '0.5rem', xl: '0.75rem', full: '9999px' },
      }},
    };
  </script>
  <style>
    .material-symbols-outlined { font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24; }
    .active-nav { background-color:rgba(236,91,19,.1); border-left:4px solid #ec5b13; color:#ec5b13; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinning { animation: spin 0.7s linear infinite; }
  </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 antialiased">

<!-- ── Offline Banner ── -->
<div id="backend-banner" class="hidden bg-amber-50 dark:bg-amber-900/20 border-b border-amber-200 dark:border-amber-800 px-6 py-2.5 text-center text-xs font-bold text-amber-700 dark:text-amber-400">
  ⚡ Demo Mode — Backend offline. Run <code class="bg-amber-100 dark:bg-amber-800 px-1 rounded">start.bat</code> to configure settings.
</div>

<div class="flex min-h-screen">

  <!-- ── Sidebar ── -->
  <aside class="w-64 border-r border-slate-200 dark:border-slate-800 bg-white dark:bg-background-dark flex flex-col fixed h-full z-40">
    <div class="p-6 flex items-center gap-3">
      <div class="bg-primary rounded-lg p-2 flex items-center justify-center shadow-lg shadow-primary/20">
        <span class="material-symbols-outlined text-white">monitoring</span>
      </div>
      <div>
        <h1 class="text-sm font-bold uppercase tracking-wider text-slate-800 dark:text-slate-100">X Tech Intel</h1>
        <p class="text-[10px] text-slate-500 dark:text-slate-400 font-medium" data-i18n="brand.subtitle">INFLUENCER ENGINE</p>
      </div>
    </div>
    <nav class="flex-1 px-4 mt-4 space-y-1">
      <a href="index.html" class="flex items-center gap-3 px-3 py-3 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-accent/10 hover:text-accent transition-colors text-sm font-medium">
        <span class="material-symbols-outlined">dashboard</span><span data-i18n="nav.dashboard">Dashboard</span>
      </a>
      <a href="#" class="flex items-center gap-3 px-3 py-3 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-accent/10 hover:text-accent transition-colors text-sm font-medium">
        <span class="material-symbols-outlined">description</span><span data-i18n="nav.reports">Reports</span>
      </a>
      <a href="influencers.html" class="flex items-center gap-3 px-3 py-3 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-accent/10 hover:text-accent transition-colors text-sm font-medium">
        <span class="material-symbols-outlined">group</span><span data-i18n="nav.influencers">Influencers</span>
      </a>
      <a href="settings.html" class="flex items-center gap-3 px-3 py-3 rounded-lg active-nav font-semibold text-sm">
        <span class="material-symbols-outlined">settings</span><span data-i18n="nav.settings">Settings</span>
      </a>
    </nav>
    <div class="px-4 pb-2">
      <button data-toggle-theme class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-sm font-medium">
        <span class="material-symbols-outlined" data-theme-icon>dark_mode</span>
        <span class="dark:hidden" data-i18n="nav.dark">Dark Mode</span><span class="hidden dark:inline" data-i18n="nav.light">Light Mode</span>
      </button>
      <button data-lang-toggle onclick="toggleLang()"
        class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-sm font-medium">
        <span class="material-symbols-outlined">translate</span>中文
      </button>
    </div>
    <div class="p-4 border-t border-slate-200 dark:border-slate-800">
      <div class="flex items-center gap-3 p-2 rounded-lg bg-slate-100 dark:bg-slate-800/50">
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-accent flex items-center justify-center text-white font-bold text-sm flex-shrink-0">AC</div>
        <div class="overflow-hidden">
          <p class="text-xs font-bold truncate">Alex Chen</p>
          <p class="text-[10px] text-slate-500">Senior Analyst · Pro</p>
        </div>
      </div>
    </div>
  </aside>

  <!-- ── Main ── -->
  <main class="ml-64 flex-1 p-8 min-h-screen max-w-4xl">

    <!-- Page Header -->
    <div class="mb-8">
      <h2 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight" data-i18n="set.title">Settings</h2>
      <p class="text-slate-500 dark:text-slate-400 mt-1 text-sm" data-i18n="set.subtitle">Configure the intelligence pipeline and connection credentials.</p>
    </div>

    <!-- ── Connection Status ── -->
    <section class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm p-6 mb-6">
      <div class="flex items-center justify-between mb-5">
        <h3 class="font-bold text-slate-900 dark:text-white text-sm uppercase tracking-wider flex items-center gap-2">
          <span class="material-symbols-outlined text-primary">hub</span><span data-i18n="set.conn_title">Connection Status</span>
        </h3>
        <div class="flex items-center gap-3">
          <span id="last-checked" class="text-[11px] text-slate-400 font-medium"></span>
          <button id="refresh-btn" title="Refresh now"
            class="p-1.5 rounded-lg text-slate-400 hover:text-primary hover:bg-primary/10 transition-colors">
            <span id="refresh-icon" class="material-symbols-outlined text-base leading-none">refresh</span>
          </button>
        </div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <!-- Backend -->
        <div class="flex items-center gap-3 p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600">
          <div id="backend-status-dot" class="w-3 h-3 rounded-full bg-slate-300 flex-shrink-0"></div>
          <div>
            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider" data-i18n="set.backend">Backend</p>
            <p id="backend-status-label" class="text-sm font-bold text-slate-900 dark:text-white">Checking…</p>
          </div>
        </div>
        <!-- X / Twitter -->
        <div class="flex items-center gap-3 p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600">
          <div id="x-status-dot" class="w-3 h-3 rounded-full bg-slate-300 flex-shrink-0"></div>
          <div>
            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider" data-i18n="set.x_account">X Account</p>
            <p id="x-status-label" class="text-sm font-bold text-slate-900 dark:text-white">—</p>
          </div>
        </div>
        <!-- Claude -->
        <div class="flex items-center gap-3 p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600">
          <div id="claude-status-dot" class="w-3 h-3 rounded-full bg-slate-300 flex-shrink-0"></div>
          <div>
            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider" data-i18n="set.claude">Claude API</p>
            <p id="claude-status-label" class="text-sm font-bold text-slate-900 dark:text-white">—</p>
          </div>
        </div>
      </div>
      <p class="mt-4 text-xs text-slate-400 leading-relaxed">
        API credentials are stored in <code class="bg-slate-100 dark:bg-slate-700 px-1 rounded font-mono">server/.env</code>.
        Edit that file to update <code class="bg-slate-100 dark:bg-slate-700 px-1 rounded font-mono">X_USERNAME</code>,
        <code class="bg-slate-100 dark:bg-slate-700 px-1 rounded font-mono">X_PASSWORD</code>, and
        <code class="bg-slate-100 dark:bg-slate-700 px-1 rounded font-mono">ANTHROPIC_API_KEY</code>.
      </p>
    </section>

    <!-- ── Data Stats ── -->
    <section class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm p-6 mb-6">
      <h3 class="font-bold text-slate-900 dark:text-white text-sm uppercase tracking-wider mb-5 flex items-center gap-2">
        <span class="material-symbols-outlined text-primary">bar_chart</span><span data-i18n="set.data_title">Data Overview</span>
      </h3>
      <div class="grid grid-cols-2 gap-4">
        <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 text-center">
          <p id="stat-reports" class="text-3xl font-black text-slate-900 dark:text-white">—</p>
          <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mt-1" data-i18n="set.reports_saved">Reports Saved</p>
        </div>
        <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-700/50 border border-slate-200 dark:border-slate-600 text-center">
          <p id="stat-influencers" class="text-3xl font-black text-slate-900 dark:text-white">—</p>
          <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mt-1" data-i18n="set.inf_tracked">Influencers Tracked</p>
        </div>
      </div>
    </section>

    <!-- ── Fetch Parameters ── -->
    <section class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm p-6 mb-6">
      <h3 class="font-bold text-slate-900 dark:text-white text-sm uppercase tracking-wider mb-5 flex items-center gap-2">
        <span class="material-symbols-outlined text-primary">tune</span><span data-i18n="set.fetch_title">Report Generation Parameters</span>
      </h3>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
        <div>
          <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2" for="fetch-hours" data-i18n="set.hours_label">
            Lookback Window (hours)
          </label>
          <input id="fetch-hours" type="number" min="1" max="168" value="24"
            class="w-full px-4 py-2.5 rounded-lg border border-slate-200 dark:border-slate-600
                   bg-slate-50 dark:bg-slate-700 text-sm font-medium focus:outline-none
                   focus:ring-2 focus:ring-primary/40 focus:border-primary transition-all"/>
          <p class="text-[11px] text-slate-400 mt-1" data-i18n="set.hours_hint">How many hours back to scan posts (default: 24)</p>
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2" for="max-per-user" data-i18n="set.max_label">
            Max Posts Per Influencer
          </label>
          <input id="max-per-user" type="number" min="1" max="100" value="20"
            class="w-full px-4 py-2.5 rounded-lg border border-slate-200 dark:border-slate-600
                   bg-slate-50 dark:bg-slate-700 text-sm font-medium focus:outline-none
                   focus:ring-2 focus:ring-primary/40 focus:border-primary transition-all"/>
          <p class="text-[11px] text-slate-400 mt-1" data-i18n="set.max_hint">Maximum posts fetched per account per run (default: 20)</p>
        </div>
      </div>

      <button id="save-btn" disabled
        class="bg-primary hover:bg-primary/90 text-white px-6 py-2.5 rounded-lg font-bold text-sm
               shadow-lg shadow-primary/20 transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
        <span class="material-symbols-outlined text-sm">save</span><span data-i18n="set.save">Save Settings</span>
      </button>
    </section>

    <!-- ── env reminder ── -->
    <section class="bg-amber-50 dark:bg-amber-900/20 rounded-xl border border-amber-200 dark:border-amber-700 p-5">
      <div class="flex items-start gap-3">
        <span class="material-symbols-outlined text-amber-500 mt-0.5">info</span>
        <div>
          <p class="text-sm font-bold text-amber-800 dark:text-amber-300 mb-1" data-i18n="set.cred_title">Credential Setup</p>
          <p class="text-xs text-amber-700 dark:text-amber-400 leading-relaxed" data-i18n="set.cred_desc">
            To enable live X data collection, edit server/.env and fill in your X account credentials and Anthropic API key. Then restart the backend with start.bat.
          </p>
          <a href="https://console.anthropic.com/" target="_blank" rel="noopener"
             class="inline-flex items-center gap-1 mt-2 text-xs font-bold text-amber-700 dark:text-amber-400 hover:underline">
            <span data-i18n="set.get_key">Get Anthropic API key</span>
            <span class="material-symbols-outlined text-xs">open_in_new</span>
          </a>
        </div>
      </div>
    </section>

  </main>
</div>

<script>
const API = "http://localhost:8000/api";

// ── Theme ─────────────────────────────────────────────────────────────────
function applyTheme(dark) { document.documentElement.classList.toggle("dark", dark); }
function toggleTheme() {
  const dark = !document.documentElement.classList.contains("dark");
  applyTheme(dark);
  localStorage.setItem("theme", dark ? "dark" : "light");
  updateThemeIcons();
}
function updateThemeIcons() {
  const dark = document.documentElement.classList.contains("dark");
  document.querySelectorAll("[data-theme-icon]").forEach(el => {
    el.textContent = dark ? "light_mode" : "dark_mode";
  });
}
(function() {
  const saved = localStorage.getItem("theme");
  const sys   = window.matchMedia("(prefers-color-scheme: dark)").matches;
  applyTheme(saved === "dark" || (!saved && sys));
})();

// ── Toast ─────────────────────────────────────────────────────────────────
function showToast(msg, type = "info") {
  const colors = { info: "bg-primary text-white", success: "bg-green-500 text-white", error: "bg-red-500 text-white" };
  const icons  = { info: "info", success: "check_circle", error: "error" };
  const el = document.createElement("div");
  el.className = `fixed bottom-6 right-6 z-50 px-5 py-3 rounded-xl shadow-xl text-sm font-bold
    flex items-center gap-2 transition-all duration-300 translate-y-10 opacity-0 ${colors[type] || colors.info}`;
  el.innerHTML = `<span class="material-symbols-outlined text-sm">${icons[type] || "info"}</span>${msg}`;
  document.body.appendChild(el);
  requestAnimationFrame(() => el.classList.remove("translate-y-10", "opacity-0"));
  setTimeout(() => { el.classList.add("translate-y-10", "opacity-0"); setTimeout(() => el.remove(), 300); }, 3500);
}

// ── API helpers ───────────────────────────────────────────────────────────
async function apiFetch(path, opts = {}) {
  const res = await fetch(API + path, {
    ...opts,
    headers: { "Content-Type": "application/json", ...(opts.headers || {}) },
  });
  if (!res.ok) {
    const err = await res.json().catch(() => ({ detail: res.statusText }));
    throw new Error(err.detail || res.statusText);
  }
  return res.json();
}

const POLL_INTERVAL = 10_000; // ms between auto-refreshes
let _pollTimer      = null;
let _polling        = false;

// ── Status dot helper ─────────────────────────────────────────────────────
function setDot(id, ok) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.remove("bg-slate-300", "bg-green-500", "bg-red-400");
  el.classList.add(ok ? "bg-green-500" : "bg-red-400");
}

// ── Refresh only the status cards (called on every poll tick) ─────────────
async function refreshStatus() {
  if (_polling) return;   // skip if a refresh is already in-flight
  _polling = true;

  const icon = document.getElementById("refresh-icon");
  icon.classList.add("spinning");

  try {
    const s      = await apiFetch("/settings");
    const banner = document.getElementById("backend-banner");

    if (banner) banner.classList.add("hidden");
    setDot("backend-status-dot", true);
    document.getElementById("backend-status-label").textContent = "Online";

    setDot("x-status-dot", s.x_configured);
    document.getElementById("x-status-label").textContent =
      s.x_configured ? `@${s.x_username || "configured"}` : "Not configured";

    setDot("claude-status-dot", s.claude_configured);
    document.getElementById("claude-status-label").textContent =
      s.claude_configured ? "API Key set" : "Not configured";

    document.getElementById("stat-reports").textContent     = s.report_count     ?? "—";
    document.getElementById("stat-influencers").textContent = s.influencer_count ?? "—";

    document.getElementById("save-btn").disabled = false;

  } catch {
    const banner = document.getElementById("backend-banner");
    if (banner) banner.classList.remove("hidden");

    setDot("backend-status-dot", false);
    document.getElementById("backend-status-label").textContent = "Offline";
    document.getElementById("x-status-label").textContent       = "—";
    document.getElementById("claude-status-label").textContent  = "—";

    document.getElementById("save-btn").disabled = true;
  } finally {
    _polling = false;
    icon.classList.remove("spinning");
    document.getElementById("last-checked").textContent =
      "Checked " + new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  }
}

// ── First load: also populate form fields ────────────────────────────────
async function loadSettings() {
  try {
    const s = await apiFetch("/settings");
    document.getElementById("fetch-hours").value  = s.fetch_hours  ?? 24;
    document.getElementById("max-per-user").value = s.max_per_user ?? 20;
  } catch { /* form keeps its default values */ }

  await refreshStatus();
}

// ── Polling control ───────────────────────────────────────────────────────
function startPolling() {
  if (_pollTimer) return;
  _pollTimer = setInterval(refreshStatus, POLL_INTERVAL);
}
function stopPolling() {
  clearInterval(_pollTimer);
  _pollTimer = null;
}

// ── Save settings ─────────────────────────────────────────────────────────
async function saveSettings() {
  const btn        = document.getElementById("save-btn");
  const fetchHours = parseInt(document.getElementById("fetch-hours").value, 10);
  const maxPerUser = parseInt(document.getElementById("max-per-user").value, 10);

  if (isNaN(fetchHours) || fetchHours < 1 || fetchHours > 168) {
    showToast("Lookback window must be 1–168 hours.", "error"); return;
  }
  if (isNaN(maxPerUser) || maxPerUser < 1 || maxPerUser > 100) {
    showToast("Max posts must be 1–100.", "error"); return;
  }

  btn.disabled = true;
  btn.innerHTML = `<span class="material-symbols-outlined text-sm" style="animation:spin .8s linear infinite">refresh</span>Saving…`;

  try {
    await apiFetch("/settings", {
      method: "POST",
      body: JSON.stringify({ fetch_hours: fetchHours, max_per_user: maxPerUser }),
    });
    showToast("Settings saved!", "success");
  } catch (e) {
    showToast(e.message, "error");
  } finally {
    btn.disabled = false;
    btn.innerHTML = `<span class="material-symbols-outlined text-sm">save</span>Save Settings`;
  }
}

// ── Init ──────────────────────────────────────────────────────────────────
document.addEventListener("DOMContentLoaded", async () => {
  updateThemeIcons();
  document.querySelectorAll("[data-toggle-theme]").forEach(el => el.addEventListener("click", toggleTheme));
  document.getElementById("save-btn").addEventListener("click", saveSettings);
  document.getElementById("refresh-btn").addEventListener("click", refreshStatus);

  await loadSettings();
  startPolling();

  // Pause polling when tab is hidden, resume + immediate refresh when visible again
  document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
      stopPolling();
    } else {
      refreshStatus();
      startPolling();
    }
  });
});
</script>
<script src="js/lang.js"></script>
</body>
</html>
